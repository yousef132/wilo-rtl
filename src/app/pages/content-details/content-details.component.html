<app-inner-page-banner [pageTitle]="'متابعة تقدم الطالب'" />

<!-- Error Message -->
<div *ngIf="error && !isInitialLoading" class="alert alert-danger m-4">
  <i class="bx bx-error-circle"></i>
  {{ error }}
  <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadInitialData()">
    إعادة المحاولة
  </button>
</div>

<!-- Loading Skeleton -->
<div *ngIf="isInitialLoading" class="instructor-content-skeleton">
  <div class="container">
    <div class="skeleton-grid">
      <div class="skeleton-card">
        <div class="skeleton-header"></div>
        <div class="skeleton-content"></div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="instructor-content-container" *ngIf="content && !isInitialLoading">
  <div class="container">
    <div class="content-grid">

      <!-- Left Column: Content Details & Student Progress -->
      <div class="left-column">

        <!-- Student Info Card -->
        <div class="info-card student-info-card">
          <div class="card-header">
            <div class="header-icon">
              <i class="bx bx-user-circle"></i>
            </div>
            <h3>معلومات الطالب</h3>
          </div>
          <div class="card-body">
            <div class="student-details">
              <div class="detail-row">
                <span class="detail-label">الاسم:</span>
                <span class="detail-value">{{ content.userName || 'غير متاح' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">حالة الاجتياز:</span>
                <span class="status-badge" [class.passed]="passedStudent || content.isPassed"
                  [class.pending]="!(passedStudent || content.isPassed)">
                  <i class="bx" [ngClass]="(passedStudent || content.isPassed) ? 'bx-check-circle' : 'bx-time'"></i>
                  {{ (passedStudent || content.isPassed) ? 'تم الاجتياز' : 'قيد الانتظار' }}
                </span>
              </div>
              <div class="detail-row" *ngIf="content.examResult !== null">
                <span class="detail-label">نتيجة الامتحان:</span>
                <span class="detail-value score">
                  <strong>{{ content.examResult }}%</strong>
                  <span class="score-details">({{ content.examResult }} من {{ content.examTotal }})</span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Details Card -->
        <div class="info-card content-info-card">
          <div class="card-header">
            <div class="header-icon">
              <i class="bx bx-book-content"></i>
            </div>
            <h3>تفاصيل المحتوى</h3>
          </div>
          <div class="card-body">
            <h2 class="content-title">{{ content.title }}</h2>

            <div class="content-meta-grid">
              <div class="meta-item">
                <i class="bx bx-category"></i>
                <span>{{ ContentType[content.contentType] }}</span>
              </div>
              <div class="meta-item">
                <i class="bx bx-time"></i>
                <span>{{ content.minutes }} دقيقة</span>
              </div>
              <div class="meta-item">
                <i class="bx bx-calendar"></i>
                <span>{{ content.recordDate | date:'shortDate' }}</span>
              </div>
              <div class="meta-item">
                <i class="bx bx-trending-up"></i>
                <span>جهد: {{ content.requiredEffort }}</span>
              </div>
            </div>

            <div class="content-description" *ngIf="content.contentText">
              <p>{{ content.contentText }}</p>
            </div>

            <!-- Content Media Preview -->
            <div class="content-preview">
              <ng-container [ngSwitch]="content.contentType">
                <!-- Video Content -->
                <div *ngIf="content.contentType == ContentType.Loom || 
                           content.contentType == ContentType.Vimeo || 
                           content.contentType == ContentType.YouTube" class="video-preview">
                  <div *ngIf="safeContentHtml" [innerHTML]="safeContentHtml"></div>
                </div>

                <!-- File Content -->
                <div *ngSwitchCase="ContentType.File" class="file-preview">
                  <a [href]="content.contentUrl" target="_blank" class="preview-link">
                    <i class="bx bx-file"></i>
                    <span>عرض الملف</span>
                    <i class="bx bx-link-external"></i>
                  </a>
                </div>

                <!-- Website Link -->
                <div *ngSwitchCase="ContentType.Website" class="website-preview">
                  <a [href]="content.contentUrl" target="_blank" class="preview-link">
                    <i class="bx bx-globe"></i>
                    <span>فتح الرابط</span>
                    <i class="bx bx-link-external"></i>
                  </a>
                </div>

                <!-- Image Content -->
                <div *ngSwitchCase="ContentType.Image" class="image-preview">
                  <img [src]="content.contentUrl" alt="صورة المحتوى" />
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- Requirements Card -->
        <div class="info-card requirements-card">
          <div class="card-header">
            <div class="header-icon">
              <i class="bx bx-task"></i>
            </div>
            <h3>متطلبات الاجتياز</h3>
          </div>
          <div class="card-body">
            <div class="requirement-info">
              <i class="bx bx-info-circle"></i>
              <p>{{ alertMessage }}</p>
            </div>

            <div class="pass-mark" *ngIf="content.passMark && 
                 (content.contentPassingRequirement === ContentPassingRequirement.Exam || 
                  content.contentPassingRequirement === ContentPassingRequirement.AiExam)">
              <i class="bx bx-target-lock"></i>
              <span>النسبة المطلوبة: {{ content.passMark }}%</span>
            </div>

            <!-- Manual Pass Button -->
            <div class="action-section" *ngIf="content.contentPassingRequirement == ContentPassingRequirement.Manually && 
                        (!content.isPassed && !passedStudent)">
              <button class="btn-pass-student" (click)="passStudent()" [disabled]="loading.navigation">
                <i class="bx" [ngClass]="loading.navigation ? 'bx-loader-alt bx-spin' : 'bx-check-circle'"></i>
                <span>{{ loading.navigation ? 'جاري التحديث...' : 'اجتياز الطالب' }}</span>
              </button>
            </div>
          </div>
        </div>


        <!-- Navigation Card -->
        <ng-container *ngIf="nextPreviewContent">
          <div class="info-card navigation-card">
            <div class="card-header">
              <div class="header-icon">
                <i class="bx bx-navigation"></i>
              </div>
              <h3>التنقل بين المحتويات</h3>
            </div>
            <div class="card-body">
              <div class="navigation-buttons">

                <!-- Previous Content -->
                <ng-container *ngIf="nextPreviewContent[0] as prev">
                  <button class="nav-btn prev-btn" *ngIf="prev" [disabled]="!prev.isOpened"
                    [routerLink]="prev.isOpened ? ['/content-details', prev.id, studentId, programId] : null">
                    <i class="bx bx-chevron-right"></i>
                    <div class="nav-btn-content">
                      <span class="nav-label">السابق</span>
                      <span class="nav-title">{{ prev.title }}</span>
                    </div>
                  </button>
                </ng-container>

                <!-- Next Content -->
                <ng-container *ngIf="nextPreviewContent[1] as next">

                  <button class="nav-btn next-btn" *ngIf="next" [disabled]="!next.isOpened"
                    [routerLink]="next.isOpened ? ['/content-details', next.id, studentId, programId] : null">
                    <div class="nav-btn-content">
                      <span class="nav-label">التالي</span>
                      <span class="nav-title">{{ next.title }}</span>
                    </div>
                    <i class="bx bx-chevron-left"></i>
                  </button>
                </ng-container>


                <div class="info-card navigation-card empty-nav" *ngIf="!nextPreviewContent[0] && !nextPreviewContent[1]">
                  <div class="card-body text-center">
                    <p>لا يوجد محتوى للتنقل حالياً</p>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </ng-container>



      </div>

      <!-- Right Column: Chat with Student -->
      <div class="right-column">
        <div class="chat-card">
          <div class="chat-header">
            <div class="header-content">
              <div class="header-icon">
                <i class="bx bx-message-dots"></i>
              </div>
              <div class="header-text">
                <h3>المحادثة مع الطالب</h3>
                <p style="color: white;">تواصل مباشر مع الطالب حول المحتوى</p>
              </div>
            </div>
            <span *ngIf="loading.chat" class="loading-indicator">
              <i class="bx bx-loader-alt bx-spin"></i>
            </span>
          </div>

          <div class="chat-body">
            <!-- Chat Loading State -->
            <div *ngIf="loading.chat" class="chat-loading">
              <div class="spinner-border text-primary"></div>
              <span>جاري تحميل الرسائل...</span>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" #messagesContainer
              *ngIf="!loading.chat && messages?.length; else noMessages">
              <div *ngFor="let msg of messages" class="message-wrapper">
                <div class="message" [ngClass]="{
                       'message-sent': msg.userId === currentUserId,
                       'message-received': msg.userId !== currentUserId
                     }">
                  <div class="message-avatar" *ngIf="msg.userId !== currentUserId">
                    {{ getUserInitials(msg.userName) }}
                  </div>
                  <div class="message-content">
                    <div class="message-header" *ngIf="msg.userId !== currentUserId">
                      <span class="message-author">{{ msg.userName }}</span>
                    </div>
                    <div class="message-text">
                      {{ msg.textMessage }}
                    </div>
                    <div class="message-time">
                      {{ msg.messageDate | date:'shortTime' }}
                      <span class="message-date">{{ msg.messageDate | date:'shortDate' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sending Indicator -->
              <div *ngIf="loading.sendingMessage" class="message-wrapper">
                <div class="message message-sent sending">
                  <div class="message-content">
                    <div class="message-text">
                      <div class="typing-indicator">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <ng-template #noMessages>
              <div class="no-messages" *ngIf="!loading.chat">
                <i class="bx bx-message-x"></i>
                <h4>لا توجد رسائل بعد</h4>
                <p>ابدأ المحادثة مع الطالب بإرسال أول رسالة</p>
              </div>
            </ng-template>
          </div>

          <div class="chat-footer">
            <div class="message-input-wrapper">
              <input [(ngModel)]="newMessage" type="text" class="message-input" placeholder="اكتب رسالتك للطالب..."
                (keyup.enter)="sendMessage()" [disabled]="loading.sendingMessage" maxlength="500" />
              <button class="send-button" (click)="sendMessage()"
                [disabled]="!newMessage.trim() || loading.sendingMessage">
                <i class="bx" [ngClass]="loading.sendingMessage ? 'bx-loader-alt bx-spin' : 'bx-send'"></i>
              </button>
            </div>
            <div class="input-footer" *ngIf="newMessage">
              <span class="char-count">{{ newMessage.length }}/500</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<ngx-spinner bdColor="rgba(79, 70, 229, 0.1)" size="default" color="#4f46e5" type="cube-transition" [fullScreen]="true"
  [zIndex]="9999">
</ngx-spinner>