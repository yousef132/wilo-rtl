<app-inner-page-banner [pageTitle]="'إدارة المحتوى'" />

<div class="content-edit-container">
  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>جاري تحميل بيانات المحتوى...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && contentData" class="content-wrapper">
    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <h2 class="page-title">تعديل المحتوى</h2>
        <a *ngIf="contentData.contentPassingRequirement == ContentPassingRequirement.Exam"
           [routerLink]="['/questions/add', contentData.id]" 
           class="add-question-btn">
          <i class="bx bx-question-mark"></i>
          <span>إضافة سؤال</span>
        </a>
      </div>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <form [formGroup]="contentForm" (ngSubmit)="onSubmit()">
        
        <!-- Basic Information Section -->
        <div class="form-section">
          <h3 class="section-title">المعلومات الأساسية</h3>
          
          <div class="form-grid">
            <!-- Title -->
            <div class="form-group full-width">
              <label class="form-label">العنوان</label>
              <input type="text" class="form-input" formControlName="title" placeholder="أدخل عنوان المحتوى" />
              <span class="error-message" *ngIf="contentForm.get('title')?.touched && contentForm.get('title')?.invalid">
                هذا الحقل مطلوب
              </span>
            </div>

            <!-- Passing Requirement -->
            <div class="form-group">
              <label class="form-label">شرط النجاح</label>
              <select class="form-select" formControlName="contentPassingRequirement" (change)="onPassingRequirementChange($event)">
                <option [value]="ContentPassingRequirement.Exam">امتحان</option>
                <option [value]="ContentPassingRequirement.Comment">تعليق</option>
                <option [value]="ContentPassingRequirement.Manually">يدوي</option>
                <option [value]="ContentPassingRequirement.AiExam">امتحان ذكي</option>
              </select>
            </div>

            <!-- Passing Mark (Conditional) -->
            <div class="form-group" *ngIf="isTypeOfExam()">
              <label class="form-label">نسبة النجاح (%)</label>
              <input type="number" class="form-input" formControlName="passingMark" placeholder="0-100" />
              <span class="error-message" *ngIf="contentForm.get('passingMark')?.touched && contentForm.get('passingMark')?.invalid">
                <span *ngIf="contentForm.get('passingMark')?.errors?.['required']">النسبة مطلوبة</span>
                <span *ngIf="contentForm.get('passingMark')?.errors?.['min']">النسبة يجب أن تكون أكبر من 0</span>
                <span *ngIf="contentForm.get('passingMark')?.errors?.['max']">النسبة يجب أن تكون أقل من أو تساوي 100</span>
              </span>
            </div>

            <!-- Required Effort -->
            <div class="form-group">
              <label class="form-label">الجهد المطلوب</label>
              <input type="text" class="form-input" formControlName="requiredEffort" placeholder="مثال: متوسط" />
            </div>

            <!-- Minutes -->
            <div class="form-group">
              <label class="form-label">عدد الدقائق</label>
              <input type="number" class="form-input" formControlName="minutes" placeholder="0" />
              <span class="error-message" *ngIf="contentForm.get('minutes')?.touched && contentForm.get('minutes')?.invalid">
                عدد الدقائق مطلوب ويجب أن يكون أكبر من 0
              </span>
            </div>

            <!-- Index (Conditional) -->
            <div class="form-group" *ngIf="contentData.status == CoachingProgramStatus.InActive">
              <label class="form-label">الترتيب</label>
              <input type="number" class="form-input" formControlName="index" placeholder="0" />
            </div>
          </div>
        </div>

        <!-- Content Type Section -->
        <div class="form-section">
          <h3 class="section-title">نوع المحتوى</h3>
          
          <div class="form-grid">
            <!-- Content Type -->
            <div class="form-group full-width">
              <label class="form-label">نوع المحتوى</label>
              <select class="form-select" formControlName="contentType" (change)="onContentTypeChange($event)">
                <option [value]="ContentType.File">ملف</option>
                <option [value]="ContentType.Loom">Loom</option>
                <option [value]="ContentType.Vimeo">Vimeo</option>
                <option [value]="ContentType.Image">صورة</option>
                <option [value]="ContentType.Website">موقع ويب</option>
                <option [value]="ContentType.YouTube">YouTube</option>
              </select>
            </div>

            <!-- File Upload (Conditional) -->
            <div class="form-group full-width" *ngIf="contentForm.get('contentType')?.value == ContentType.File">
              <label class="form-label">الملف</label>
              <div class="file-upload-wrapper">
                <input type="file" id="fileInput" class="file-input" (change)="onFileSelected($event)" />
                <label for="fileInput" class="file-upload-label">
                  <i class="bx bx-cloud-upload"></i>
                  <span>{{ selectedFile ? selectedFile.name : 'اختر ملف أو اسحبه هنا' }}</span>
                </label>
              </div>
              
              <div *ngIf="fileError" class="error-message">{{ fileError }}</div>
              
              <!-- <div *ngIf="contentData?.contentUrl && !selectedFile" class="current-file-info">
                <i class="bx bx-file"></i>
                 <a [href]="contentData.contentUrl" target="_blank">عرض الملف الحالي</a> 
              </div> -->
            </div>

            <!-- URL (Conditional) -->
            <div class="form-group full-width" *ngIf="contentForm.get('contentType')?.value != ContentType.File && contentForm.get('contentType')?.value != null">
              <label class="form-label">الرابط</label>
              <input type="url" class="form-input" formControlName="contentUrl" placeholder="https://example.com" />
              <span class="error-message" *ngIf="contentForm.get('contentUrl')?.touched && contentForm.get('contentUrl')?.invalid">
                الرابط غير صالح
              </span>
            </div>
          </div>
        </div>

        <!-- Text Content Section -->
        <div class="form-section">
          <h3 class="section-title">الوصف</h3>
          <div class="form-group full-width">
            <label class="form-label">نص المحتوى</label>
            <textarea class="form-textarea" formControlName="textContent" rows="5" placeholder="أدخل وصف المحتوى..."></textarea>
          </div>
        </div>

        <!-- Features Section -->
        <div class="form-section">
          <h3 class="section-title">المميزات</h3>
          
          <div class="features-grid">
            <!-- AI Chat Toggle -->
            <div class="toggle-group">
              <div class="toggle-content">
                <div class="toggle-info">
                  <i class="bx bx-bot toggle-icon"></i>
                  <div>
                    <h4 class="toggle-title">الدردشة مع الذكاء الاصطناعي</h4>
                    <p class="toggle-description">السماح للطلاب بطرح الأسئلة على المساعد الذكي</p>
                  </div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" formControlName="isAiChatEnabled" />
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Instructor Chat Toggle -->
            <div class="toggle-group">
              <div class="toggle-content">
                <div class="toggle-info">
                  <i class="bx bx-user toggle-icon"></i>
                  <div>
                    <h4 class="toggle-title">الدردشة مع المدرب</h4>
                    <p class="toggle-description">السماح للطلاب بالتواصل المباشر مع المدرب</p>
                  </div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" formControlName="isInstructorChatEnabled" (change)="onInstructorChatToggle($event)"  />
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="contentForm.invalid || fileError != null || isSubmitting">
            <span *ngIf="isSubmitting" class="btn-spinner"></span>
            <i class="bx bx-save" *ngIf="!isSubmitting"></i>
            <span>{{ isSubmitting ? 'جاري الحفظ...' : 'حفظ التعديلات' }}</span>
          </button>
          
          <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="isSubmitting">
            <i class="bx bx-reset"></i>
            <span>إعادة تعيين</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !contentData" class="error-state">
    <div class="error-icon">⚠️</div>
    <h3>حدث خطأ في تحميل البيانات</h3>
    <p>نعتذر، لم نتمكن من تحميل بيانات المحتوى</p>
    <button class="btn btn-primary" (click)="getContentData()">
      <i class="bx bx-refresh"></i>
      <span>إعادة المحاولة</span>
    </button>
  </div>
</div>