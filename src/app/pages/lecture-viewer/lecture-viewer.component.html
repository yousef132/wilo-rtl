<div class="lecture-viewer" style="margin-top: 100px;" dir="rtl">
    <!-- Error Message -->
    <div *ngIf="error && !isInitialLoading" class="error-banner">
      <i class="bx bx-error-circle"></i>
      <span>{{ error }}</span>
      <button class="retry-btn" (click)="loadInitialData()">
        ุฅุนุงุฏุฉ ุงููุญุงููุฉ
      </button>
    </div>

    <!-- Loading State -->
    <div *ngIf="isInitialLoading" class="loading-container">
      <div class="loading-spinner">
        <i class="bx bx-loader-alt bx-spin"></i>
      </div>
      <p>ุฌุงุฑู ุชุญููู ุงููุญุชูู...</p>
    </div>
    
    <!-- Navigation Loading Overlay -->
    <div *ngIf="loading.navigation" class="navigation-loading-overlay">
      <div class="navigation-loading-content">
        <div class="navigation-spinner">
          <i class="bx bx-loader-alt bx-spin"></i>
        </div>
        <p>ุฌุงุฑู ุชุญููู ุงููุญุชูู...</p>
      </div>
    </div>
    
    <!-- Mobile Header -->
    <div class="mobile-header" *ngIf="(currentLecture || showCourseCompletion) && !isInitialLoading">
      <button class="mobile-menu-btn" (click)="toggleMobileSidebar()">
        <i class="bx bx-menu"></i>
      </button>
      <h3 class="mobile-title">{{ showCourseCompletion ? 'ุชู ุฅููุงู ุงูุฏูุฑุฉ!' : currentLecture?.title }}</h3>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div class="mobile-overlay" [class.active]="isMobileSidebarOpen" (click)="toggleMobileSidebar()"></div>

    <div class="main-container" *ngIf="(currentLecture || showCourseCompletion) && !isInitialLoading">
      <!-- Left Side - Main Content -->
      <div class="main-content">
        
        <!-- Course Completion Congratulations -->
        <div *ngIf="showCourseCompletion" class="course-completion-container">
          <div class="completion-header">
            <div class="completion-icon">
              <i class="bx bx-trophy"></i>
            </div>
            <h1 class="completion-title">๐ ูุจุฑูู! ุชู ุฅููุงู ุงูุฏูุฑุฉ ุจูุฌุงุญ</h1>
            <p class="completion-subtitle">ููุฏ ุฃูููุช ุฌููุน ูุญุงุถุฑุงุช ุงูุฏูุฑุฉ ุจูุฌุงุญ</p>
          </div>

          <div class="completion-content">
            <div class="completion-stats">
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="bx bx-book-open"></i>
                </div>
                <div class="stat-info">
                  <span class="stat-number">{{ getTotalLecturesCount() }}</span>
                  <span class="stat-label">ูุญุงุถุฑุฉ ููุชููุฉ</span>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="bx bx-time"></i>
                </div>
                <div class="stat-info">
                  <span class="stat-number">{{ getTotalCourseDuration() }}</span>
                  <span class="stat-label">ุฏูููุฉ ูู ุงูุชุนูู</span>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="stat-icon">
                  <i class="bx bx-check-circle"></i>
                </div>
                <div class="stat-info">
                  <span class="stat-number">100%</span>
                  <span class="stat-label">ูุณุจุฉ ุงูุฅูุฌุงุฒ</span>
                </div>
              </div>
            </div>

            <div class="completion-certificate-info">
              <div class="certificate-icon">
                <i class="bx bx-medal"></i>
              </div>
              <div class="certificate-text">
                <h3>ุดูุงุฏุฉ ุฅุชูุงู ุงูุฏูุฑุฉ</h3>
                <p>ุณูุชู ุฅุฑุณุงู ุดูุงุฏุฉ ุฅุชูุงู ุงูุฏูุฑุฉ ุฅูู ุจุฑูุฏู ุงูุฅููุชุฑููู ุฎูุงู ุฏูุงุฆู</p>
                <p class="notification-text">
                  <i class="bx bx-bell"></i>
                  ุณุชุญุตู ุนูู ุฅุดุนุงุฑ ููุฑ ูุตูู ุงูุดูุงุฏุฉ
                </p>
              </div>
            </div>

            <div class="completion-actions">
              <!-- <button class="action-btn primary" (click)="goToNextCourse()" *ngIf="hasNextCourse">
                <i class="bx bx-right-arrow-alt"></i>
                ุงูุงูุชูุงู ููุฏูุฑุฉ ุงูุชุงููุฉ
              </button> -->
              
              <!-- <button class="action-btn secondary" (click)="goToCourseOverview()">
                <i class="bx bx-book"></i>
                ุนุฑุถ ุชูุงุตูู ุงูุฏูุฑุฉ
              </button>
              
              <button class="action-btn secondary" (click)="shareAchievement()">
                <i class="bx bx-share"></i>
                ูุดุงุฑูุฉ ุงูุฅูุฌุงุฒ
              </button> -->
            </div>
          </div>
        </div>

        <!-- Regular Lecture Content (when not showing completion) -->
        <div *ngIf="!showCourseCompletion">
          <div class="lecture-header">
            <div class="lecture-title-section">
              <h1 class="lecture-title">{{ currentLecture?.title }}</h1>
              <div class="lecture-meta">
                <span class="badge" [ngClass]="getContentTypeBadgeClass(currentLecture?.contentType!)">
                  {{ getContentTypeBadge(currentLecture?.contentType!) }}
                </span>
                <span class="duration">
                  <i class="bx bx-time"></i>
                  {{ currentLecture?.minutes }} ุฏูููุฉ
                </span>
                <span class="created-date">
                  <i class="bx bx-calendar"></i>
                  {{ currentLecture?.recordDate | date:'dd/MM/yyyy' }}
                </span>
                <!-- Pass Status -->
                <span *ngIf="currentLecture?.isPassed || passedStudent" class="pass-status">
                  <i class="bx bx-check-circle"></i>
                  ุชู ุงูุงุฌุชูุงุฒ
                  <span *ngIf="currentLecture?.examResult" class="exam-score">
                    ({{ currentLecture?.examResult }}%)
                  </span>
                </span>
              </div>
            </div>

            <!-- Navigation Controls -->
            <div class="navigation-controls">
              <button class="nav-btn prev-btn" [disabled]="!canNavigatePrevious()" (click)="navigateToPrevious()">
                <i class="bx bx-chevron-right"></i>
                ุงูุณุงุจู
              </button>
              <button class="nav-btn next-btn" [disabled]="!canNavigateNext()" (click)="navigateToNext()">
                ุงูุชุงูู
                <i class="bx bx-chevron-left"></i>
              </button>
            </div>
          </div>

          <!-- Content Description -->
          <div class="content-description" *ngIf="currentLecture?.contentText">
            <p>{{ currentLecture?.contentText }}</p>
          </div>

          <!-- Content Display -->
          <div class="content-display">
            <!-- Video Content (YouTube, Vimeo, Loom) -->
            <div *ngIf="currentLecture?.contentType === ContentType.YouTube || 
                        currentLecture?.contentType === ContentType.Vimeo || 
                        currentLecture?.contentType === ContentType.Loom" class="video-container">
              <div *ngIf="safeContentHtml" [innerHTML]="safeContentHtml" class="video-wrapper"></div>
            </div>

            <!-- Image Content -->
            <div *ngIf="currentLecture?.contentType === ContentType.Image" class="image-container">
              <img [src]="currentLecture?.contentUrl" [alt]="currentLecture?.title">
            </div>

            <!-- Text Content -->
            <div *ngIf="currentLecture?.contentType === ContentType.Text" class="text-content">
              <div class="text-body">{{ currentLecture?.contentUrl }}</div>
            </div>

            <!-- File Content -->
            <div *ngIf="currentLecture?.contentType === ContentType.File" class="file-container">
              <div class="file-viewer">
                <i class="bx bx-file file-icon"></i>
                <h3>{{ currentLecture?.title }}</h3>
                <p>ูุนุฑุถ ูุฐุง ุงููููุ ูุฑุฌู ุงูููุฑ ุนูู ุงูุฑุงุจุท ุฃุฏูุงู</p>
                <a [href]="currentLecture?.contentUrl" target="_blank" class="download-btn">
                  <i class="bx bx-download"></i>
                  ุชุญููู/ุนุฑุถ ุงูููู
                </a>
              </div>
            </div>

            <!-- Website Content -->
            <div *ngIf="currentLecture?.contentType === ContentType.Website" class="website-container">
              <div class="website-link-container">
                <i class="bx bx-globe website-icon"></i>
                <h3>{{ currentLecture?.title }}</h3>
                <p>ุงููุฑ ุนูู ุงูุฑุงุจุท ุฃุฏูุงู ููุชุญ ุงููููุน</p>
                <a [href]="currentLecture?.contentUrl" target="_blank" class="website-btn">
                  <i class="bx bx-link-external"></i>
                  ูุชุญ ุงููููุน
                </a>
              </div>
            </div>
          </div>

          <!-- Requirements Alert -->
          <div *ngIf="!currentLecture?.isPassed && !passedStudent && !currentLecture?.isOwner" class="requirements-alert">
            <div class="alert-content">
              <i class="bx bx-info-circle"></i>
              <div class="alert-text">
                <span>{{ alertMessage }}</span>
              </div>
            </div>

            <!-- Exam Links -->
            <div class="exam-actions"
              *ngIf="currentLecture?.contentPassingRequirement === ContentPassingRequirement.Exam || 
                                              currentLecture?.contentPassingRequirement === ContentPassingRequirement.AiExam">
              <button class="exam-btn" (click)="takeExam()">
                <i class="bx"
                  [ngClass]="currentLecture?.contentPassingRequirement === ContentPassingRequirement.AiExam ? 'bx-brain' : 'bx-edit'"></i>
                {{ currentLecture?.contentPassingRequirement === ContentPassingRequirement.AiExam ? 'ุงูุฐูุงุจ ููุงูุชุญุงู ุงูุฐูู'
                : 'ุงูุฐูุงุจ ููุงูุชุญุงู' }}
              </button>

              <div *ngIf="currentLecture?.passMark" class="pass-mark">
                <i class="bx bx-target-lock"></i>
                <span>ุงููุณุจุฉ ุงููุทููุจุฉ ูููุฌุงุญ: {{ currentLecture?.passMark }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Toggle Button (only show when not in completion mode) -->
        <div class="chat-toggle-container" *ngIf="!showCourseCompletion">
          <button class="chat-toggle-btn" (click)="toggleChat()">
            <i class="bx bx-message-dots"></i>
            {{ isChatOpen ? 'ุฅุบูุงู ุงูุฏุฑุฏุดุฉ' : 'ูุชุญ ุงูุฏุฑุฏุดุฉ' }}
          </button>
        </div>
      </div>

      <!-- Right Side - Course Content Sidebar -->
      <div class="sidebar" [class.mobile-open]="isMobileSidebarOpen">
        <div class="sidebar-header">
          <h2>{{courseStructure?.title}}</h2>
          <button class="mobile-close-btn" (click)="toggleMobileSidebar()">
            <i class="bx bx-x"></i>
          </button>
        </div>

        <div class="course-content" *ngIf="courseStructure">
          <!-- Course Progress Summary -->
          <div class="course-progress">
            <div class="progress-header">
              <h3>{{ courseStructure.title }}</h3>
              <span class="progress-percentage">{{ getProgressPercentage() }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
            </div>
            <p class="progress-text">
              {{ getCompletedLecturesCount() }} ูู {{ getTotalLecturesCount() }} ูุญุงุถุฑุฉ
            </p>
          </div>

          <!-- Course Sections -->
          <div class="course-sections">
            <div class="course-section" *ngFor="let section of courseStructure.sections">
              <!-- Section Header -->
              <div class="section-header" (click)="toggleSection(section.id)">
                <div class="section-title-container">
                  <i class="bx section-icon" [ngClass]="section.isExpanded ? 'bx-chevron-down' : 'bx-chevron-left'"></i>
                  <h4 class="section-title">{{ section.title }}</h4>
                </div>
                <div class="section-progress">
                  <span class="section-count">
                    {{ getSectionCompletedCount(section) }}/{{ section.lectures.length }}
                  </span>
                </div>
              </div>

              <!-- Section Lectures -->
              <div class="section-lectures" [class.expanded]="section.isExpanded">
                <div class="lecture-item" *ngFor="let lecture of section.lectures"
                  [class.current]="lecture.id === contentId"
                  [class.locked]="!lecture.isPassed && !canAccessLecture(lecture)" [class.completed]="lecture.isPassed"
                  (click)="onLectureClick(lecture)">

                  <!-- Lecture Status Icon -->
                  <div class="lecture-status">
                    <i class="bx status-icon" [ngClass]="getLectureStatusIcon(lecture)"></i>
                  </div>

                  <!-- Lecture Content -->
                  <div class="lecture-content">
                    <div class="lecture-header">
                      <h5 class="lecture-title">{{ lecture.title }}</h5>
                      <div class="lecture-badges">
                        <span class="content-type-badge" [ngClass]="getContentTypeBadgeClass(lecture.contentType)">
                          {{ getContentTypeBadge(lecture.contentType) }}
                        </span>
                      </div>
                    </div>

                    <div class="lecture-meta">
                      <span class="lecture-duration">
                        <i class="bx bx-time"></i>
                        {{ lecture.minutes }} ุฏูููุฉ
                      </span>
                    </div>
                  </div>

                  <!-- Current Indicator -->
                  <div class="current-indicator" *ngIf="lecture.id === contentId">
                    <i class="bx bx-play-circle"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div class="course-loading" *ngIf="!courseStructure && loading.courseStructure">
          <div class="loading-spinner">
            <i class="bx bx-loader-alt bx-spin"></i>
          </div>
          <p>ุฌุงุฑู ุชุญููู ูุญุชูู ุงูุฏูุฑุฉ...</p>
        </div>


        <!-- Empty State -->
        <div class="course-empty" *ngIf="!courseStructure && !loading.courseStructure">
          <i class="bx bx-book-open"></i>
          <h4>ูุง ููุฌุฏ ูุญุชูู ูุชุงุญ</h4>
          <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ูุญุชูู ููุฏูุฑุฉ</p>
        </div>
      </div>
    </div>

    <!-- Chat Modal (Large) - Only show when not in completion mode -->
    <div class="chat-modal-overlay" [class.active]="isChatOpen && !showCourseCompletion" (click)="toggleChat()">
      <div class="chat-modal" #chatModal (click)="$event.stopPropagation()">
        <div class="chat-modal-header">
          <div class="chat-title">
            <i class="bx bx-message-dots"></i>
            <h3>ุงููุญุงุฏุซุฉ - {{ currentLecture?.title }}</h3>
          </div>

          <div class="chat-controls">
            <!-- Chat Mode Tabs -->
            <div class="chat-mode-tabs">
              <button class="chat-mode-tab" [class.active]="chatMode === 'instructor'"
                (click)="switchChatMode('instructor')">
                <i class="bx bx-user"></i>
                ุงููุฏุฑุจ
                <span *ngIf="loading.chat" class="loading-dot"></span>
              </button>
              <button class="chat-mode-tab" [class.active]="chatMode === 'ai'" (click)="switchChatMode('ai')">
                <i class="bx bx-brain"></i>
                ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                <span *ngIf="loading.aiChat" class="loading-dot"></span>
              </button>
            </div>

            <button class="close-chat-btn" (click)="toggleChat()">
              <i class="bx bx-x"></i>
            </button>
          </div>
        </div>

        <div class="chat-modal-body">
          <!-- Instructor Chat -->
          <div *ngIf="chatMode === 'instructor'" class="chat-content">
            <!-- Loading State -->
            <div *ngIf="loading.chat" class="chat-loading">
              <div class="loading-spinner">
                <i class="bx bx-loader-alt bx-spin"></i>
              </div>
              <p>ุฌุงุฑู ุชุญููู ุงูุฑุณุงุฆู...</p>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" #messagesContainer
              *ngIf="!loading.chat && messages?.length; else noInstructorMessages">
              <div *ngFor="let msg of messages" class="message-wrapper">
                <div class="message" [ngClass]="{
                      'message-sent': msg.userId === currentUserId,
                      'message-received': msg.userId !== currentUserId
                    }">
                  <div class="message-content">
                    <div class="message-header" *ngIf="msg.userId !== currentUserId">
                      <div class="user-avatar">
                        {{ getUserInitials(msg.userName) }}
                      </div>
                      <span class="user-name">{{ msg.userName }}</span>
                    </div>

                    <div class="message-text">
                      {{ msg.textMessage }}
                    </div>

                    <div class="message-time">
                      {{ msg.messageDate | date:'shortTime' }}
                      <span class="message-date">{{ msg.messageDate | date:'shortDate' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sending Message Indicator -->
              <div *ngIf="loading.sendingMessage" class="message-wrapper">
                <div class="message message-sent sending">
                  <div class="message-content">
                    <div class="message-text">
                      <div class="typing-indicator">
                        <div class="typing-dots">
                          <span class="dot"></span>
                          <span class="dot"></span>
                          <span class="dot"></span>
                        </div>
                        <span class="typing-text">ุฌุงุฑู ุงูุฅุฑุณุงู...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <ng-template #noInstructorMessages>
              <div class="no-messages" *ngIf="!loading.chat">
                <i class="bx bx-message-x"></i>
                <h4>ูุง ุชูุฌุฏ ุฑุณุงุฆู ูุน ุงููุฏุฑุจ ุญุชู ุงูุขู</h4>
                <p>ุงุจุฏุฃ ุงููุญุงุฏุซุฉ ูุน ุงููุฏุฑุจ ุจุฅุฑุณุงู ุฃูู ุฑุณุงูุฉ</p>
              </div>
            </ng-template>
          </div>

          <!-- AI Chat -->
          <div *ngIf="chatMode === 'ai'" class="chat-content">
            <!-- Loading State -->
            <div *ngIf="loading.aiChat" class="chat-loading">
              <div class="loading-spinner">
                <i class="bx bx-loader-alt bx-spin"></i>
              </div>
              <p>ุฌุงุฑู ุชุญููู ุงููุญุงุฏุซุฉ ูุน ุงููุณุงุนุฏ ุงูุฐูู...</p>
            </div>

            <!-- AI Messages Container -->
            <div class="messages-container" #aiMessagesContainer
              *ngIf="!loading.aiChat && aiMessages?.length; else noAiMessages">
              <div *ngFor="let msg of aiMessages" class="message-wrapper">
                <div class="message" [ngClass]="{
                      'message-sent': msg.role === AIChatRole.User,
                      'message-received': msg.role === AIChatRole.Assistant,
                      'message-ai': msg.role === AIChatRole.Assistant
                    }">
                  <div class="message-content">
                    <div class="message-header" *ngIf="msg.role === AIChatRole.Assistant">
                      <div class="user-avatar ai-avatar">
                        <i class="bx bx-brain"></i>
                      </div>
                      <span class="user-name">ุงููุณุงุนุฏ ุงูุฐูู</span>
                    </div>

                    <div class="message-text">
                      {{ msg.messageText }}
                    </div>

                    <div class="message-time">
                      {{ msg.sentAt | date:'shortTime' }}
                      <span class="message-date">{{ msg.sentAt | date:'shortDate' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- AI Thinking Animation -->
              <div *ngIf="aiIsThinking" class="message-wrapper">
                <div class="message message-received message-ai">
                  <div class="message-content">
                    <div class="message-header">
                      <div class="user-avatar ai-avatar">
                        <i class="bx bx-brain"></i>
                      </div>
                      <span class="user-name">ุงููุณุงุนุฏ ุงูุฐูู</span>
                    </div>

                    <div class="message-text">
                      <div class="typing-indicator">
                        <div class="typing-dots">
                          <span class="dot"></span>
                          <span class="dot"></span>
                          <span class="dot"></span>
                        </div>
                        <span class="typing-text">ูููุฑ...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <ng-template #noAiMessages>
              <div class="no-messages" *ngIf="!loading.aiChat">
                <i class="bx bx-brain"></i>
                <h4>ูุง ุชูุฌุฏ ุฑุณุงุฆู ูุน ุงููุณุงุนุฏ ุงูุฐูู ุญุชู ุงูุขู</h4>
                <p>ุงุณุฃู ุงููุณุงุนุฏ ุงูุฐูู ุฃู ุณุคุงู ูุชุนูู ุจุงููุญุชูู</p>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-modal-footer">
          <div class="message-input-container">
            <!-- Instructor Chat Input -->
            <div class="input-group" *ngIf="chatMode === 'instructor'">
              <input [(ngModel)]="newMessage" type="text" class="message-input" placeholder="ุงูุชุจ ุฑุณุงูุชู ูููุฏุฑุจ ููุง..."
                (keyup.enter)="sendMessage()" [disabled]="loading.sendingMessage" maxlength="500" #instructorInput />
              <button class="send-button" (click)="sendMessage()"
                [disabled]="!newMessage.trim() || loading.sendingMessage">
                <i class="bx" [ngClass]="loading.sendingMessage ? 'bx-loader-alt bx-spin' : 'bx-send'"></i>
              </button>
            </div>

            <!-- AI Chat Input -->
            <div class="input-group" *ngIf="chatMode === 'ai'">
              <input [(ngModel)]="prompt" type="text" class="message-input" placeholder="ุงุณุฃู ุงููุณุงุนุฏ ุงูุฐูู..."
                (keyup.enter)="sendAiMessage()" maxlength="500" [disabled]="loading.sendingAiMessage" #aiInput />
              <button class="send-button" (click)="sendAiMessage()"
                [disabled]="!prompt.trim() || loading.sendingAiMessage">
                <i class="bx" [ngClass]="loading.sendingAiMessage ? 'bx-loader-alt bx-spin' : 'bx-send'"></i>
              </button>
            </div>

            <!-- Character Count -->
            <div class="input-footer" *ngIf="(chatMode === 'instructor' && newMessage) || (chatMode === 'ai' && prompt)">
              <span class="char-count">
                {{ chatMode === 'instructor' ? newMessage.length : prompt.length }}/500
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>